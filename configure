#!/bin/bash

MAKE32=""

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

for args in "$@"
do
	if [ $args == "--make-32bit" ]; then
		MAKE32="$args"
	fi
done

cd "$DIR"

echo "Checking xz utils"
(xz --version) < /dev/null > /dev/null 2>&1 || {
	echo
	echo "xz utils not detected!"
	echo
	sleep 3
	exit 1
}

echo "Checking zip utils"
(xz --version) < /dev/null > /dev/null 2>&1 || {
	echo
	echo "zip utils not detected!"
	echo
	sleep 3
	exit 1
}

echo "Checking mono-runtime"
(mono --version) < /dev/null > /dev/null 2>&1 || {
	echo
	echo "mono CLR not detected!"
	echo
	sleep 3
	exit 1
}

echo "Checking mono compiler (xbuild)"
(xbuild /version) < /dev/null > /dev/null 2>&1 || {
	echo
	echo "mono compiler (xbuild) not detected!"
	echo
	sleep 3
	exit 1
}

echo "Checking mono compiler (msbuild)"
(msbuild /version) < /dev/null > /dev/null 2>&1 || {
	echo
	echo "mono compiler (msbuild) not detected!"
	echo
	sleep 3
	exit 1
}

echo "Checking git"
(git --version) < /dev/null > /dev/null 2>&1 || {
	echo
	echo "git not detected!"
	echo
	sleep 3
	exit 1
}

echo "Checking Newtonsoft.Json at ../"
if [ -f "../Newtonsoft.Json/Src/Newtonsoft.Json/Newtonsoft.Json.Net40.csproj" ]; then
	echo "    Newtonsoft.Json found!"
	sleep 1
else
	echo "    Newtonsoft.Json not found, downloading..."
	git clone https://github.com/JamesNK/Newtonsoft.Json "../Newtonsoft.Json"
	cd "../Newtonsoft.Json"
	git checkout 10.0.2
	cd "$DIR"
fi

echo "Checking FFmpegDotNet at ../"
if [ -f "../FFmpegDotNet/FFmpegDotNet/FFmpegDotNet.csproj" ]; then
	echo "    FFmpegDotNet found!"
	sleep 1
else
	echo "    FFmpegDotNet not found, downloading..."
	git clone https://github.com/Anime4000/FFmpegDotNet "../FFmpegDotNet"
fi

echo "Checking plugin archive"
if [ -f "plugin.tar.xz" ]; then
	echo "    Plugins found!"
	sleep 1
else
	echo "    Plugin not found, downloading..."
	if [ ! -z $MAKE32 ]; then
		echo "    32-bit builds"
		wget --no-check-certificate https://sourceforge.net/projects/ifme/files/plugin/plugin-basic-x86_2017-06-25.tar.xz -O plugin.tar.xz
	else
		echo "    64-bit builds"
		wget --no-check-certificate https://sourceforge.net/projects/ifme/files/plugin/plugin-basic-amd64_2017-06-25.tar.xz -O plugin.tar.xz
	fi
fi

echo "Done, now you can make"
exit 0
